<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Velvet</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0" />
  <link rel="stylesheet" href="estilos.css">
</head>

<body>

  <div id="notification-container"></div>

  <div class="modal" id="modalEliminar">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box has-text-centered">
        <h3 class="title is-4">Â¿Eliminar registro?</h3>
        <p>Esta acciÃ³n no se puede deshacer.</p>
        <div class="buttons is-centered mt-5">
          <button id="confirmarBorrarBtn" class="button is-danger">SÃ­, eliminar</button>
          <button onclick="cerrarEliminar()" class="button">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <section class="section">
    <div class="container">
      <div class="has-text-centered mb-5">
        <h1 class="title is-2"><span class="material-symbols-rounded">pets</span> Velvet</h1>
      </div>

      <div class="box is-radiusless" style="border-radius: 12px !important; background: #f5f5f5;">
        <div class="columns is-vcentered">
          <div class="column is-4">
            <div class="field">
              <label class="label is-small">Filtrar por tablero</label>
              <div class="select is-fullwidth is-rounded">
                <select id="filtroEstado">
                  <option value="todas">Todos los pacientes</option>
                  <option value="Abierta">Abiertas</option>
                  <option value="Terminada">Terminadas</option>
                  <option value="Anulada">Anuladas</option>
                </select>
              </div>
            </div>
          </div>
          <div class="column has-text-right">
            <button id="btnAbrirModal" class="button is-primary is-rounded is-medium">
              <span class="material-symbols-rounded mr-2">add</span> Agendar Paciente
            </button>
          </div>
        </div>
      </div>

      <div id="listaCitas" class="columns is-multiline"></div>
    </div>
  </section>

  <div class="modal" id="modalCita">
    <div class="modal-background" onclick="cerrarModalCita()"></div>
    <div class="modal-card">
      <header class="modal-card-head has-background-primary">
        <p class="modal-card-title has-text-white">Registro de Paciente</p>
        <button class="delete" onclick="cerrarModalCita()"></button>
      </header>
      <div id="mensajeError" class="notification is-danger is-light" style="display:none;"></div>
      <section class="modal-card-body">
        <div class="columns is-multiline">
          <div class="column is-6"><label class="label">Mascota</label><input id="mascota" class="input"></div>
          <div class="column is-6">
            <label class="label">Especie</label>
            <div class="select is-fullwidth"><select id="tipoMascota">
                <option value="perro">Perro</option>
                <option value="gato">Gato</option>
                <option value="capibara">Capibara</option>
                <option value="conejo">Conejo</option>
                <option value="loro">loro</option>
                <option value="araÃ±a">AraÃ±a</option>
                <option value="serpiente">Serpiente</option>
                <option value="pez">Pez</option>
                <option value="cerdo">Cerdo</option>
                <option value="pollo">Pollo</option>
              </select></div>
          </div>
          <div class="column is-6"><label class="label">DueÃ±o</label><input id="propietario" class="input"></div>
          <div class="column is-6">
            <label class="label">Estado</label>
            <div class="select is-fullwidth"><select id="estado">
                <option value="Abierta">Abierta</option>
                <option value="Terminada">Terminada</option>
                <option value="Anulada">Anulada</option>
              </select></div>
          </div>
          <div class="column is-6"><label class="label">Fecha</label><input id="fecha" type="date" class="input"></div>
          <div class="column is-6"><label class="label">Hora</label><input id="hora" type="time" class="input"
              min="08:00" max="20:00">
          </div>
          <div class="column is-12"><label class="label">SÃ­ntomas</label><textarea id="sintomas" class="textarea"
              rows="2"></textarea></div>
      </section>
      <footer class="modal-card-foot">

        <button id="guardarCita" class="button is-success is-fullwidth">Confirmar Datos</button>
      </footer>
    </div>
  </div>

  <script>
    let citas = JSON.parse(localStorage.getItem('citas_vet')) || [];
    let editingID = null;
    let borrandoID = null;
    const fechaInput = document.getElementById("fecha");
    const hoy = new Date();
    hoy.setDate(hoy.getDate() + 1);
    fechaInput.min = hoy.toISOString().split("T")[0];
    function mostrarCitas() {
      const filtro = document.getElementById("filtroEstado").value;
      const lista = document.getElementById("listaCitas");
      lista.innerHTML = "";

      const filtradas = citas.filter(c => filtro === "todas" || c.estado === filtro);

      filtradas.forEach(c => {
        const tagColor = c.estado === 'Abierta' ? 'is-success' : c.estado === 'Terminada' ? 'is-info' : 'is-danger';
        // Dentro del filtradas.forEach de tu funciÃ³n mostrarCitas:
        lista.innerHTML += `
  <div class="column is-4">
    <div class="card mascota-card">
      <video class="video-background" autoplay muted loop playsinline>
        <source src="./videos/${c.tipoMascota.toLowerCase()}.mp4" type="video/mp4">
      </video>
      <div class="video-overlay"></div>

      <div class="cositas">
        <div class="card-content-wrapper">
          
          <h2 class="card-title-main">${c.mascota}</h2>
          <span class="tag ${tagColor} is-rounded mb-2">${c.estado.toUpperCase()}</span>
          <div class="data-box">
            <div class="columns is-mobile is-multiline is-gapless">
              <div class="column is-6 info-item">
                <span class="info-label">Especie</span>
                <strong>${c.tipoMascota}</strong>
              </div>
              <div class="column is-6 info-item">
                <span class="info-label">Cita</span>
                <strong>${c.hora}</strong>
              </div>
              <div class="column is-12 info-item">
                <span class="info-label">Propietario</span>
                <strong>${c.propietario}</strong>
              </div>
            </div>
            <div class="info-item mt-2">
              <p class="is-size-7 is-italic" style="color: #bbb;">"${c.sintomas}"</p>
            </div>
          </div>
        </div>

        <footer class="card-footer">
          <a class="card-footer-item" onclick="prepararEdicion(${c.id})">EDITAR</a>
          <a class="card-footer-item has-text-danger" onclick="abrirEliminar(${c.id})">ELIMINAR</a>
        </footer>
      </div>
    </div>
  </div>`;
      });
    }

    // Funciones de Modal y Guardado (se mantienen igual pero con IDs corregidos)
    document.getElementById("btnAbrirModal").onclick = () => {
      editingID = null;
      document.querySelectorAll('.input, textarea').forEach(el => el.value = "");

      const mensaje = document.getElementById("mensajeError");
      mensaje.style.display = "none";
      mensaje.innerHTML = "";

      document.getElementById("modalCita").classList.add("is-active");
    };


    function cerrarModalCita() { document.getElementById("modalCita").classList.remove("is-active"); }

    document.getElementById("guardarCita").onclick = () => {

      const mensaje = document.getElementById("mensajeError");
      mensaje.style.display = "none";
      mensaje.innerHTML = "";

      const data = {
        mascota: document.getElementById('mascota').value.trim(),
        tipoMascota: document.getElementById('tipoMascota').value,
        propietario: document.getElementById('propietario').value.trim(),
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        sintomas: document.getElementById('sintomas').value.trim(),
        estado: document.getElementById('estado').value,
        id: editingID || Date.now()
      };

      // ðŸ”´ 1. Validar campos vacÃ­os
      if (!data.mascota) {
        mensaje.innerHTML = "Es necesario colocar el nombre de la mascota.";
        mensaje.style.display = "block";
        return;
      } else if (!data.propietario) {
        mensaje.innerHTML = "Es necesario colocar el nombre del dueÃ±o.";
        mensaje.style.display = "block";
        return;
      } else if (!data.fecha) {
        mensaje.innerHTML = "Es necesario colocar la fecha.";
        mensaje.style.display = "block";
        return;
      } else if (!data.hora) {
        mensaje.innerHTML = "Es necesario colocar la hora.";
        mensaje.style.display = "block";
        return;
      } else if (!data.sintomas) {
        mensaje.innerHTML = "Es necesario colocar los sÃ­ntomas.";
        mensaje.style.display = "block";
        return;
      }

      // ðŸ”´ 2. Validar hora entre 8:00 y 20:00
      const [hora] = data.hora.split(":").map(Number);

      if (hora < 8 || hora >= 20) {
        mensaje.innerHTML = "La hora debe estar entre 8:00 AM y 8:00 PM.";
        mensaje.style.display = "block";
        return;
      }

      // ðŸ”´ 3. Validar fecha mÃ­nima (maÃ±ana)
      const fechaSeleccionada = new Date(data.fecha);
      const manana = new Date();
      manana.setDate(manana.getDate() + 1);
      manana.setHours(0, 0, 0, 0);

      if (fechaSeleccionada < manana) {
        mensaje.innerHTML = "La fecha debe ser a partir de maÃ±ana.";
        mensaje.style.display = "block";
        return;
      }

      // ðŸ”´ 4. Validar cita repetida (fecha + hora)
      const repetida = citas.some(c =>
        c.fecha === data.fecha &&
        c.hora === data.hora &&
        c.id !== editingID
      );

      if (repetida) {
        mensaje.innerHTML = "Ya existe una cita registrada en esa fecha y hora.";
        mensaje.style.display = "block";
        return;
      }

      // âœ… Guardar si todo estÃ¡ correcto
      if (editingID) {
        const index = citas.findIndex(c => c.id === editingID);
        citas[index] = data;
      } else {
        citas.push(data);
      }

      localStorage.setItem('citas_vet', JSON.stringify(citas));
      mostrarCitas();
      cerrarModalCita();
    };

    window.abrirEliminar = (id) => {
      borrandoID = id;
      document.getElementById("modalEliminar").classList.add("is-active");
    };

    function cerrarEliminar() { document.getElementById("modalEliminar").classList.remove("is-active"); }

    document.getElementById("confirmarBorrarBtn").onclick = () => {
      citas = citas.filter(c => c.id !== borrandoID);
      localStorage.setItem('citas_vet', JSON.stringify(citas));
      mostrarCitas();
      cerrarEliminar();
    };

    window.prepararEdicion = (id) => {
      const c = citas.find(x => x.id === id);
      editingID = id;
      document.getElementById('mascota').value = c.mascota;
      document.getElementById('tipoMascota').value = c.tipoMascota;
      document.getElementById('propietario').value = c.propietario;
      document.getElementById('fecha').value = c.fecha;
      document.getElementById('hora').value = c.hora;
      document.getElementById('sintomas').value = c.sintomas;
      document.getElementById('estado').value = c.estado;
      document.getElementById("modalCita").classList.add("is-active");
    };

    window.limpiarTodo = () => { if (confirm("Â¿Borrar todo?")) { localStorage.clear(); citas = []; mostrarCitas(); } };

    document.getElementById("filtroEstado").onchange = mostrarCitas;
    mostrarCitas();
  </script>
</body>

</html>