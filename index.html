<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VetManager Pro | Video Edition</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0" />

  <style>
    /* --- ESTILOS DE LA CARTA --- */
    .mascota-card {
      border-radius: 15px;
      border: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      background: #2c3e50;
      z-index: 1;
      min-height: 240px;
    }

    .video-background {
      position: absolute;
      top: 50%; left: 50%;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: translate(-50%, -50%);
      z-index: -2;
    }

    .video-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.7) 100%);
      z-index: -1;
    }

    /* --- NOTIFICACIÓN DE ERROR FLOTANTE --- */
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      width: 300px;
    }

    .notification.is-danger {
      animation: slideIn 0.4s ease forwards;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .input.is-invalid, .textarea.is-invalid, .select.is-invalid select {
      border: 2px solid #ff3860 !important;
      background-color: #fff8f8;
    }
  </style>
</head>

<body>

  <div id="notification-container"></div>

  <section class="section">
    <div class="container">
      <div class="has-text-centered mb-5">
        <h1 class="title is-2"><span class="material-symbols-rounded">pets</span> VetManager Pro</h1>
      </div>

      <div class="box is-radiusless" style="border-radius: 12px !important;">
        <div class="columns is-vcentered">
          <div class="column is-4">
            <div class="field">
              <label class="label is-small">Filtrar por tablero</label>
              <div class="select is-fullwidth is-rounded">
                <select id="filtroEstado">
                  <option value="todas">Todos los pacientes</option>
                  <option value="Abierta">Abiertas</option>
                  <option value="Terminada">Terminadas</option>
                  <option value="Anulada">Anuladas</option>
                </select>
              </div>
            </div>
          </div>
          <div class="column has-text-right">
            <button onclick="limpiarTodo()" class="button is-light is-rounded is-small mr-2">Limpiar Base de Datos</button>
            
            <button id="btnAbrirModal" class="button is-primary is-rounded is-medium">
              <span class="material-symbols-rounded mr-2">add</span> Agendar Paciente
            </button>
          </div>
        </div>
      </div>

      <div id="listaCitas" class="columns is-multiline"></div>
    </div>
  </section>

  <div class="modal" id="modalCita">
    <div class="modal-background" onclick="cerrarModalCita()"></div>
    <div class="modal-card">
      <header class="modal-card-head has-background-primary">
        <p class="modal-card-title has-text-white">Registro de Paciente</p>
        <button class="delete" aria-label="close" onclick="cerrarModalCita()"></button>
      </header>
      <section class="modal-card-body">
        <div class="columns is-multiline">
          <div class="column is-6">
            <label class="label">Mascota</label>
            <input id="mascota" class="input" placeholder="Nombre">
          </div>
          <div class="column is-6">
            <label class="label">Especie</label>
            <div class="select is-fullwidth" id="selectCont-tipoMascota">
              <select id="tipoMascota">
                <option value="">Seleccione...</option>
                <option value="perro">Perro</option>
                <option value="gato">Gato</option>
                <option value="ave">Ave</option>
                <option value="reptil">Reptil</option>
                <option value="conejo">Conejo</option>
              </select>
            </div>
          </div>
          <div class="column is-6">
            <label class="label">Estado</label>
            <div class="select is-fullwidth is-info">
              <select id="estado">
                <option value="Abierta">Abierta</option>
                <option value="Terminada">Terminada</option>
                <option value="Anulada">Anulada</option>
              </select>
            </div>
          </div>
          <div class="column is-6">
            <label class="label">Propietario</label>
            <input id="propietario" class="input">
          </div>
          <div class="column is-6">
            <label class="label">Fecha</label>
            <input id="fecha" type="date" class="input">
          </div>
          <div class="column is-6">
            <label class="label">Hora</label>
            <input id="hora" type="time" class="input">
          </div>
          <div class="column is-12">
            <label class="label">Síntomas</label>
            <textarea id="sintomas" class="textarea" rows="2"></textarea>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="guardarCita" class="button is-success is-fullwidth">Confirmar Datos</button>
      </footer>
    </div>
  </div>

  <script>
    // 1. CARGA INICIAL: Si quieres que inicie VACÍO de verdad, borra tu historial del navegador o usa el botón "Limpiar Base de Datos"
    let citas = JSON.parse(localStorage.getItem('citas_vet')) || [];
    let editingID = null;

    const camposOBL = ['mascota', 'tipoMascota', 'propietario', 'fecha', 'hora', 'sintomas'];

    function mostrarError(mensaje) {
      const container = document.getElementById('notification-container');
      const notif = document.createElement('div');
      notif.className = 'notification is-danger is-light';
      notif.innerHTML = `<button class="delete"></button>${mensaje}`;
      container.appendChild(notif);
      setTimeout(() => { if(notif) notif.remove(); }, 3000);
      notif.querySelector('.delete').onclick = () => notif.remove();
    }

    document.getElementById("btnAbrirModal").onclick = () => {
      editingID = null;
      camposOBL.forEach(id => {
          const el = document.getElementById(id);
          el.value = "";
          el.classList.remove('is-invalid');
      });
      document.getElementById("modalCita").classList.add("is-active");
    };

    function cerrarModalCita() { 
      document.getElementById("modalCita").classList.remove("is-active"); 
    }

    document.getElementById("guardarCita").onclick = () => {
      let faltantes = [];
      const data = { estado: document.getElementById('estado').value };

      camposOBL.forEach(id => {
        const el = document.getElementById(id);
        if (!el.value) {
          faltantes.push(id);
          el.classList.add('is-invalid');
        } else {
          el.classList.remove('is-invalid');
          data[id] = el.value;
        }
      });

      if (faltantes.length > 0) {
        mostrarError("Por favor llena los campos marcados en rojo.");
        return;
      }

      if (editingID) {
        const index = citas.findIndex(c => c.id === editingID);
        citas[index] = { ...data, id: editingID };
      } else {
        citas.push({ ...data, id: Date.now() });
      }

      localStorage.setItem('citas_vet', JSON.stringify(citas));
      mostrarCitas();
      cerrarModalCita();
    };

    // 2. FUNCIÓN DE BORRADO (CORREGIDA)
    window.borrar = (id) => {
      if(confirm("¿Estás seguro de eliminar este registro?")) {
          citas = citas.filter(c => c.id !== id);
          localStorage.setItem('citas_vet', JSON.stringify(citas));
          mostrarCitas();
      }
    };

    // 3. FUNCIÓN PARA LIMPIAR TODO (POR SI QUIERES VACIAR LA MEMORIA)
    window.limpiarTodo = () => {
        if(confirm("Esto borrará TODAS las citas. ¿Continuar?")) {
            localStorage.removeItem('citas_vet');
            citas = [];
            mostrarCitas();
        }
    };

    function mostrarCitas() {
      const filtro = document.getElementById("filtroEstado").value;
      const lista = document.getElementById("listaCitas");
      lista.innerHTML = "";

      citas.filter(c => filtro === "todas" || c.estado === filtro).forEach(c => {
        const tagColor = c.estado === 'Abierta' ? 'is-success' : c.estado === 'Terminada' ? 'is-info' : 'is-danger';
        lista.innerHTML += `
          <div class="column is-4">
            <div class="card mascota-card">
              <video class="video-background" autoplay muted loop playsinline><source src="${c.tipoMascota.toLowerCase()}.mp4" type="video/mp4"></video>
              <div class="video-overlay"></div>
              <div class="card-content" style="color: white !important;">
                <p class="title is-4 mb-1 has-text-white">${c.mascota}</p>
                <div class="tags has-addons mb-3">
                  <span class="tag is-dark">${c.tipoMascota.toUpperCase()}</span>
                  <span class="tag ${tagColor}">${c.estado}</span>
                </div>
                <div class="content is-small">
                  <p><strong>Dueño:</strong> ${c.propietario}<br>
                  <strong>Fecha:</strong> ${c.fecha} | ${c.hora}</p>
                </div>
              </div>
              <footer class="card-footer" style="border-top: 1px solid rgba(255,255,255,0.2)">
                <a class="card-footer-item has-text-info-light" onclick="prepararEdicion(${c.id})">Editar</a>
                <a class="card-footer-item has-text-danger-light" onclick="borrar(${c.id})">Borrar</a>
              </footer>
            </div>
          </div>`;
      });
    }

    window.prepararEdicion = (id) => {
      const cita = citas.find(c => c.id === id);
      editingID = id;
      camposOBL.forEach(campo => document.getElementById(campo).value = cita[campo]);
      document.getElementById('estado').value = cita.estado;
      document.getElementById("modalCita").classList.add("is-active");
    };

    document.getElementById("filtroEstado").onchange = mostrarCitas;
    mostrarCitas();
  </script>
</body>
</html>